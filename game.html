<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudoku 6 - Premium Play</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        [x-cloak] { display: none !important; }
        
        body { 
            margin: 0; background: #05060a; 
            font-family: 'Inter', sans-serif; 
            height: 100vh; width: 100vw; overflow: hidden;
            color: white;
        }
        
        .main-scroll-container {
            height: 100vh; overflow-y: auto; scroll-behavior: smooth;
            display: flex; flex-direction: column; align-items: center; padding: 40px 0;
            position: relative; z-index: 10;
        }

        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        .game-card { 
            background: rgba(20, 22, 30, 0.85); 
            backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 40px; box-shadow: 0 40px 100px rgba(0, 0, 0, 0.8); 
            width: 92%; max-width: 440px; padding: 32px;
        }

        .sudoku-grid { background: #ffffff; border: 4px solid #000; border-radius: 16px; overflow: hidden; }
        .thick-r { border-right: 4px solid #000 !important; }
        .thick-b { border-bottom: 4px solid #000 !important; }

        .blink-green { animation: g-flash 0.8s ease-in-out forwards; }
        .blink-red { animation: r-flash 0.5s ease-in-out forwards; }
        @keyframes g-flash { 0%, 100% { background: white; } 50% { background: #10b981; color: white; } }
        @keyframes r-flash { 0%, 100% { background: white; } 50% { background: #ef4444; color: white; } }

        .cell-selected { background: #3b82f6 !important; color: white !important; z-index: 20; transform: scale(1.05); }
        .related-bg { background-color: rgba(59, 130, 246, 0.08); }
        
        .premium-stat { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; }
        .life-heart { filter: drop-shadow(0 0 8px rgba(255, 59, 48, 0.6)); font-size: 1.3rem; }
        .life-lost { opacity: 0.1; filter: grayscale(1); font-size: 1.3rem; }

        .modal-glass {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
        }

        .glitch-text {
            animation: glitch 1s linear infinite;
            text-shadow: 2px 0 #ff3b30, -2px 0 #00ffff;
        }
        @keyframes glitch {
            2%, 64% { transform: translate(2px,0) skew(0deg); }
            4%, 60% { transform: translate(-2px,0) skew(0deg); }
            62% { transform: translate(0,0) skew(5deg); }
        }
    </style>
</head>
<body x-data="sudokuPro()" x-init="initGame()">

<canvas id="bgCanvas"></canvas>

<div class="main-scroll-container">
    <div class="game-card" x-cloak>
        <div class="flex justify-between items-center mb-8">
            <button @click="saveAndExit()" class="text-[10px] font-black tracking-[2px] bg-white/5 px-5 py-2.5 rounded-2xl border border-white/5 hover:bg-white/10 transition-all uppercase">
                Save & Exit
            </button>
            
            <div class="flex gap-2">
                <template x-for="i in 5">
                    <span :class="i <= lives ? 'life-heart' : 'life-lost'">‚ù§Ô∏è</span>
                </template>
            </div>

            <div class="premium-stat px-4 py-2 flex items-center gap-2 font-bold">
                <span x-text="coins" class="text-sm"></span><span class="text-yellow-400 text-xs">ü™ô</span>
            </div>
        </div>

        <div class="text-center mb-8">
            <p class="text-[9px] opacity-40 uppercase tracking-[6px] font-black mb-1">Sudoku Expert Challenge</p>
            <h1 class="text-4xl font-black italic tracking-tighter uppercase leading-none">Level <span x-text="level"></span></h1>
        </div>

        <div class="sudoku-grid grid grid-cols-6 mb-8 shadow-2xl">
            <template x-for="(cell, i) in grid" :key="i">
                <div @click="selectedIndex = i"
                    :class="{
                        'h-14 sm:h-16 flex items-center justify-center text-2xl font-bold cursor-pointer border border-gray-100 transition-all duration-150': true,
                        'thick-r': (i + 1) % 3 === 0 && (i + 1) % 6 !== 0,
                        'thick-b': Math.floor(i / 6) === 1 || Math.floor(i / 6) === 3,
                        'cell-selected shadow-xl': selectedIndex === i,
                        'related-bg': isRelated(i) && selectedIndex !== i,
                        'blink-green': cell.blinkingGreen,
                        'blink-red': cell.blinkingRed,
                        'font-black text-gray-900': cell.fixed,
                        'text-blue-600': !cell.fixed && cell.value !== 0
                    }" x-text="cell.value !== 0 ? cell.value : ''"></div>
            </template>
        </div>

        <div class="grid grid-cols-6 gap-3 mb-8">
            <template x-for="n in 6">
                <button @click="inputNum(n)" 
                    class="bg-white/10 hover:bg-blue-600 py-4 rounded-2xl font-black text-xl transition-all active:scale-90 border border-white/5" x-text="n"></button>
            </template>
        </div>

        <div class="flex gap-4">
            <button @click="useHint()" :disabled="coins < 2" 
                class="flex-[2] bg-white text-black py-5 rounded-3xl font-black text-[11px] uppercase tracking-widest disabled:opacity-20 hover:bg-blue-400 transition-colors">
                Hint (2ü™ô)
            </button>
            <button @click="deleteCell()" 
                class="flex-1 bg-white/5 text-white py-5 rounded-3xl font-black text-[11px] uppercase tracking-widest border border-white/10 hover:bg-red-500/20">
                Clear
            </button>
        </div>

        <div class="mt-10 text-center opacity-30 text-[9px] uppercase tracking-[4px] font-bold">
            Developed by Charan Sai
        </div>
    </div>
</div>

<div x-show="gameOver" class="fixed inset-0 bg-black/95 flex flex-col items-center justify-center z-[200] p-6 text-center" x-cloak x-transition.opacity>
    <img src="https://media.giphy.com/media/VGu7IkRPBYOwcGIvP2/giphy.gif" alt="Game Over" class="w-64 h-64 object-contain mb-4">
    <h2 class="text-6xl font-black italic uppercase tracking-tighter glitch-text mb-2 text-white">Game Over</h2>
    <p class="text-red-500 font-bold tracking-[4px] text-xs mb-10 uppercase">Lives Empty -10 COINS PENALTY</p>
    <button @click="window.location.href = 'main.html'" class="bg-white text-black px-12 py-5 rounded-full font-black uppercase text-xs tracking-widest hover:bg-red-500 hover:text-white transition-all shadow-xl">
        Back to Menu
    </button>
</div>

<div x-show="showRules" class="fixed inset-0 bg-black/95 flex items-center justify-center p-6 z-[100]" x-cloak x-transition.opacity>
    <div class="modal-glass rounded-[48px] p-10 max-w-sm w-full shadow-2xl relative border border-white/20">
        <h2 class="text-4xl font-black text-gray-900 mb-1 tracking-tighter">How to Play</h2>
        <p class="text-gray-400 text-[10px] font-bold uppercase tracking-[3px] mb-8">Mastering 6x6 Sudoku</p>

        <div class="space-y-4 mb-10">
            <div class="flex gap-4 items-start bg-gray-50 p-4 rounded-2xl border border-gray-100">
                <span class="text-xl">üß©</span>
                <p class="text-gray-600 text-sm leading-relaxed">Fill the grid so every <b>row</b> and <b>column</b> has numbers 1‚Äì6 without repeats.</p>
            </div>
            <div class="flex gap-4 items-start bg-gray-50 p-4 rounded-2xl border border-gray-100">
                <span class="text-xl">üì¶</span>
                <p class="text-gray-600 text-sm leading-relaxed">Each <b>2x3 rectangle</b> (bold border) must contain numbers 1‚Äì6 exactly once.</p>
            </div>
            <div class="flex gap-4 items-start bg-gray-50 p-4 rounded-2xl border border-gray-100">
                <span class="text-xl">‚ù§Ô∏è</span>
                <p class="text-gray-600 text-sm leading-relaxed">Lose all 5 lives and face a <b>-10ü™ô Penalty</b>. Play carefully!</p>
            </div>
        </div>

        <button @click="showRules = false" class="w-full bg-gray-900 text-white py-6 rounded-3xl font-black text-xs uppercase tracking-[4px] shadow-xl hover:bg-blue-600 transition-all">
            Enter Game
        </button>
    </div>
</div>

<div x-show="won" class="fixed inset-0 bg-black/90 flex items-center justify-center p-6 z-[100]" x-cloak x-transition>
    <div class="bg-white p-12 rounded-[50px] text-center max-w-xs w-full">
        <div class="text-5xl mb-6 animate-bounce">‚ú®</div>
        <h2 class="text-4xl font-black text-gray-900 mb-6 uppercase tracking-tighter">Victory</h2>
        
        <div class="bg-blue-50 py-6 rounded-[32px] mb-8 border border-blue-100">
            <p class="text-4xl font-black text-blue-600">+<span x-text="calculateReward()"></span> ü™ô</p>
            <p class="text-[10px] text-blue-400 font-bold uppercase tracking-widest mt-1">Level Reward</p>
        </div>
        
        <button @click="nextLevel()" class="w-full bg-gray-900 text-white py-6 rounded-3xl font-black text-xs uppercase tracking-[4px] hover:bg-blue-600 transition-all">
            Next Level
        </button>
    </div>
</div>

<script src="motion.js"></script>
<script>
const firebaseConfig = { databaseURL: "https://sudokugame6x6-default-rtdb.firebaseio.com/" };
if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
const db = firebase.database();
const gamerName = localStorage.getItem("gamerName");

function sudokuPro() {
    return {
        grid: [], solution: [], selectedIndex: null, 
        level: parseInt(localStorage.getItem("currentLevel")) || 1, 
        // Logic: if 'coins' key exists, use it (even if it is 0). Otherwise, default to 50 for new users.
        coins: localStorage.getItem("coins") !== null ? parseInt(localStorage.getItem("coins")) : 50, 
        lives: 5, won: false, showRules: true, gameOver: false,
        
        initGame() {
            // Re-check storage to ensure UI is perfectly synced
            const storedCoins = localStorage.getItem("coins");
            if (storedCoins !== null) this.coins = parseInt(storedCoins);

            const params = new URLSearchParams(window.location.search);
            if (params.get('resume') === 'true' && localStorage.getItem("saved_sudoku_game")) {
                const data = JSON.parse(localStorage.getItem("saved_sudoku_game"));
                this.grid = data.grid;
                this.solution = data.solution;
                this.level = data.level || this.level;
                this.lives = data.lives || 5;
                this.showRules = false; 
            } else {
                this.generateLevel();
            }
        },

        async syncToFirebase() {
            // Always update local storage first so a refresh doesn't reset coins
            localStorage.setItem("coins", this.coins);
            localStorage.setItem("currentLevel", this.level);
            
            if (gamerName) {
                await db.ref('players/' + gamerName).update({
                    coins: this.coins,
                    level: this.level
                });
            }
        },

        saveAndExit() {
            if (!this.won && !this.gameOver) {
                localStorage.setItem("saved_sudoku_game", JSON.stringify({
                    grid: this.grid, solution: this.solution, level: this.level, lives: this.lives
                }));
            }
            this.syncToFirebase().then(() => { window.location.href = 'main.html'; });
        },

        generateLevel() {
            let b = Array(36).fill(0);
            this.solveSudoku(b);
            this.solution = [...b];
            let clues = 15; 
            this.grid = b.map(v => ({ 
                value: Math.random() > clues/36 ? 0 : v, 
                fixed: false, blinkingGreen: false, blinkingRed: false 
            }));
            this.grid.forEach(c => { if(c.value !== 0) c.fixed = true; });
            this.lives = 5;
            this.won = false;
            this.gameOver = false;
        },

        inputNum(n) {
            if (this.selectedIndex === null || this.grid[this.selectedIndex].fixed || this.won || this.gameOver) return;
            let cell = this.grid[this.selectedIndex];
            
            if (n === this.solution[this.selectedIndex]) {
                cell.value = n;
                this.checkBlinks(this.selectedIndex); 
                if (this.grid.every((c, i) => c.value === this.solution[i])) this.handleWin();
            } else {
                cell.value = n;
                cell.blinkingRed = true;
                this.lives--;
                
                if (this.lives <= 0) {
                    this.coins = Math.max(0, this.coins - 10);
                    localStorage.removeItem("saved_sudoku_game");
                    this.syncToFirebase();
                    this.gameOver = true;
                    return;
                }
                setTimeout(() => { cell.blinkingRed = false; cell.value = 0; }, 500);
            }
        },

        calculateReward() { return 5 + this.lives; },

        useHint() {
            if (this.coins < 2 || this.selectedIndex === null || this.grid[this.selectedIndex].fixed || this.won) return;
            this.coins -= 2;
            let idx = this.selectedIndex;
            this.grid[idx].value = this.solution[idx];
            this.grid[idx].fixed = true;
            this.checkBlinks(idx);
            this.syncToFirebase();
            if (this.grid.every((c, i) => c.value === this.solution[i])) this.handleWin();
        },

        checkBlinks(idx) {
            const row = Math.floor(idx / 6), col = idx % 6;
            if([...Array(6)].every((_,i) => this.grid[row*6+i].value === this.solution[row*6+i])) this.triggerBlink(i => Math.floor(i/6) === row);
            if([...Array(6)].every((_,i) => this.grid[col+i*6].value === this.solution[col+i*6])) this.triggerBlink(i => (i % 6) === col);
        },

        triggerBlink(condition) {
            this.grid.forEach((cell, i) => {
                if(condition(i)) {
                    cell.blinkingGreen = true;
                    setTimeout(() => { cell.blinkingGreen = false; }, 800);
                }
            });
        },

        handleWin() {
            localStorage.removeItem("saved_sudoku_game");
            this.coins += this.calculateReward();
            setTimeout(() => { this.won = true; this.syncToFirebase(); }, 600);
        },

        nextLevel() { 
            this.level++; this.won = false; this.syncToFirebase(); this.generateLevel(); 
        },

        isRelated(i) {
            if (this.selectedIndex === null) return false;
            let r1 = Math.floor(this.selectedIndex / 6), c1 = this.selectedIndex % 6;
            let r2 = Math.floor(i / 6), c2 = i % 6;
            return r1 === r2 || c1 === c2;
        },

        deleteCell() { 
            if(this.selectedIndex !== null && !this.grid[this.selectedIndex].fixed && !this.won) this.grid[this.selectedIndex].value = 0; 
        },

        solveSudoku(b) {
            for (let i = 0; i < 36; i++) {
                if (b[i] === 0) {
                    let ns = [1,2,3,4,5,6].sort(() => Math.random()-0.5);
                    for (let n of ns) { if (this.isValid(b, i, n)) { b[i] = n; if (this.solveSudoku(b)) return true; b[i] = 0; } }
                    return false;
                }
            }
            return true;
        },

        isValid(b, idx, n) {
            let r = Math.floor(idx/6), c = idx%6;
            for (let i=0; i<6; i++) if (b[r*6+i]===n || b[i*6+c]===n) return false;
            let br = Math.floor(r/2)*2, bc = Math.floor(c/3)*3;
            for (let i=0; i<2; i++) for (let j=0; j<3; j++) if (b[(br+i)*6+(bc+j)]===n) return false;
            return true;
        }
    }
}
</script>
</body>
</html>